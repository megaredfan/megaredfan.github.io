## 定时任务全新升级，从此“鸟枪换炮”

### 简单的ScheduledTask
对于业务开发中很普遍的定时任务需求，基础架构提供了定时任务组件[ScheduledTask](https://wiki.corp.kuaishou.com/x/EbUJD)。不过ScheduledTask的功能和实现比较基础，主要是通过zk锁保证实例间互斥以及利用定时线程池触发业务逻辑，使用ScheduledTask的用户只需要实现业务逻辑然后将服务部署到服务器即可。

使用ScheduleTask可以帮助用户快速开发搭建业务，但是也有很多局限和不足，比如API比较原始，用户需要实现许多含义不明的方法、功能单一，无法动态调整运行间隔以及临时触发、运维成本高，需要自行建设监控报警、缺少中心化的调度，只能通过zk进行抢占、配套设施不完善，没有可视的控制台等等。随着公司业务规模的发展壮大，一个简单的ScheduleTask已经无法满足开发人员日益增长的业务开发和维护需求了。

### 全新的定时任务解决方案-任务调度平台
为此基础架构借助星环平台的支持建设了ScheduledTask的升级加强版: [任务调度平台](https://halo.corp.kuaishou.com/task/#/task)，旨在提供完善的定时任务解决方案，包括支持任务的运行周期管理和配套的运维管理功能等等。任务调度平台在立项和设计阶段就充分考虑了ScheduledTask目前的不足和用户对定时任务组件的需求与反馈，目标就是降低用户的使用成本，提高用户的使用体验，与业界的同类产品对齐。未来ScheduledTask相关的功能演进和问题解决也主要在任务调度平台上体现。

#### 功能特性

##### 触发方式

任务调度平台目前支持手动触发和定时触发两种类型的触发方式，其中定时触发目前仅支持unix风格的cron定时触发（不支持秒级别），后续预计会提供更加多样化的触发方式。

##### 运行时任务控制

任务调度平台的首要的设计思路就是将“控制”和“业务”区分开，用户的代码只需要关注如何实现业务逻辑即可，而与定时任务相关的控制逻辑则全部在平台上进行操作。

任务调度平台支持任务的动态启停以及动态调整任务的运行参数，包括触发间隔、业务参数、调度策略等等，避免每次变更都需要重新打包上线，降低运维成本。

##### 自带监控报警
任务调度平台支持基于运行记录的监控报警，用户可以在平台上查看任务的运行历史并配置异常报警，目前报警触发条件包括异常（运行中抛出异常、触发失败等）和超时两种。任务调度平台默认会在异常情况下向任务对应的负责人发送报警，超时报警则需要自行开启。

任务调度平台的报警能力基于公司统一的报警网关建设，支持指定报警级别、报警通道以及报警接收人的配置，同时也支持将报警通过kim机器人进行推送。

除了异常报警，任务调度平台还支持任务成功时的推送，目前仅支持kim和kim机器人。

##### 兼容ScheduledTask

任务调度平台作为ScheduledTask的升级版，对原有的ScheduledTask也做了部分的兼容。上面提到的监控报警和结果推送功能同样适用于ScheduledTask，而动态控制的功能则暂时不支持。

##### 自定义调度策略

任务调度平台目前支持三种调度策略：随机、轮询和固定实例（第一个或最后一个），用户同样可以在任务运行时动态调整策略。

#### 未来规划
以下简要介绍一下任务调度平台的部分规划，大家如果有任何意见或建议也欢迎联系xiongjiyuan反馈交流。

* 支持任务分片：对于部分单机无法在期望的时间内完成的任务，根据当前部署的实例数或者指定的分片总数进行分片，提高运行效率。
* 更加多样、精细的触发条件：支持更多的定时触发方式（fix rate/fix reate/秒级别触发等），以及基于事件的触发方式（webhook、mq事件、hive数据ready等）
* 多语言支持：支持c++、python、shell等语言或者脚本
* 开放api：目前任务调度平台仅支持web页面操作，后续会提供开放api，用于和其他系统集成
* 支持日志收集展示：通过平台直接查看异常的历史记录对应的日志
* 分布式计算支持：支持类似hadoop中的MapReduce模型，将任务分布到各个实例然后再汇总执行结果
* 支持DAG工作流编排：支持任务的依赖和自动触发
* 支持资源托管：用户只需要提供代码就可以定时拉起实例运行，而不需要自己部署服务进行冷备，运行结束后又可以自动回收资源，降低成本

### 最后
最后附上任务调度平台用户沟通群的二维码，欢迎大家试用任务调度平台，提出宝贵的意见和建议。

![3328b86a47334e4f277568055a92a933.png](/img/二维码.png)
